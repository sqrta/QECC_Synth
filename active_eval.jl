using TensorNetworkCodes
using Combinatorics
# using TensorNetworkCodes.TNDecode
println("start")
# code = rotated_surface_code(3);

function error_prob(error, px, py, pz)
    n = length(error)
    prob = 1.0
    for i in 1:n
        ex = px[i]*(1-pz[i])
        ez = pz[i]*(1-px[i])
        ey = px[i]*pz[i]
        pauli = Dict(0=>1-ex-ey-ez, 1=>ex, 2=>ey, 3=>ez) 
        prob *= pauli[error[i]]
    end
    return prob
end


function activeCodeEval(stabilizers, k, px,py, pz, Decoder)
    n = length(stabilizers[1])
    batch = 4
    a = fill(0:3, n-batch)
    b = fill(0:3, batch)
    stab_group = [Tuple(pauli_product(term)) for term in combinations(stabilizers)]
    resA = collect(Iterators.product(a...))
    resB = collect(Iterators.product(b...))
    allErrorA = collect(Iterators.flatten(collect((resA,))))
    allErrorB = collect(Iterators.flatten(collect((resB,))))
    trivialS = [0 for i in stabilizers]
    SyndromeProbDict = Dict()
    for B in allErrorB
        for A in allErrorA        
            Error = (B..., A...)
            prob = error_prob(Error, px, py, pz)
            if Error in stab_group
                SyndromeProbDict[trivialS][1]+=prob
            else
                syndrome = pauli_commutation.(stabilizers, Ref(collect(Error)))
                if !haskey(SyndromeProbDict, syndrome)
                    SyndromeProbDict[syndrome]=[prob]
                else
                    append!(SyndromeProbDict[syndrome], prob)
                end
            end
        end
    end
    
    pl = Decoder(SyndromeProbDict)
    detectE = DetectError(SyndromeProbDict[trivialS])
    return pl, detectE

end

function DetectError(ProbDis)
    probs = sort(ProbDis, rev=true)
    return 1 - probs[1]/sum(probs)
end

function MaxLikeDecode(SyndromeProbDict)
    PL = 1
    for (key, value) in SyndromeProbDict
       sort!(value, rev=true)    
       PL -= value[1]
    end 
    return PL
end

struct CodeWithError
    stabs
    px
    pz
end

stabs1 = [[1, 3, 3, 1, 0], [0, 1, 3, 3, 1], [1, 0, 1, 3, 3], [3, 1, 0, 1, 3]]
stabs2 = [[0, 2, 3, 3, 1], [3, 0, 1, 3, 2], [3, 3, 0, 1, 1], [1, 3, 3, 0, 2]]
steane= [[0, 0, 0, 1, 1, 1, 1], [0, 1, 1, 0, 0, 1, 1], [1, 0, 1, 0, 1, 0, 1], [0, 0, 0, 3, 3, 3, 3], [0, 3, 3, 0, 0, 3, 3], [3, 0, 3, 0, 3, 0, 3]]
found713 = [[1, 0, 0, 0, 3, 3, 3], [3, 2, 0, 0, 3, 0, 2], [3, 0, 2, 0, 3, 0, 2], [3, 0, 0, 2, 3, 0, 2], [0, 3, 3, 3, 1, 3, 2], [3, 3, 3, 3, 0, 2, 3]]
code_10_1_4=CodeWithError([[1, 3, 0, 3, 0, 1, 0, 3, 3, 0], [0, 2, 0, 3, 3, 2, 0, 0, 3, 3], [0, 0, 2, 3, 3, 2, 0, 1, 0, 0], [0, 3, 3, 2, 0, 2, 3, 0, 0, 3], [0, 3, 0, 0, 1, 2, 3, 2, 0, 0], [0, 3, 3, 0, 3, 3, 1, 1, 3, 3], [0, 0, 3, 3, 3, 3, 3, 0, 1, 3], [0, 3, 3, 3, 3, 0, 0, 3, 3, 1], [3, 3, 3, 3, 3, 3, 0, 0, 0, 0]],[0.00896408387412595, 0.013909363000998987, 0.012922285286285251, 0.013909363000998987, 0.013909363000998987, 0.014895453637998046, 0.010945164670461582, 0.0119342195057911, 0.0119342195057911, 0.0119342195057911],[0.04411042164244039, 0.0677698805845951, 0.06308530712019611, 0.0677698805845951, 0.0677698805845951, 0.07243103118167216, 0.05364542018655705, 0.05837719308562428, 0.05837719308562428, 0.05837719308562428])
code_11_1_5=CodeWithError([[1, 3, 0, 3, 0, 1, 0, 3, 3, 0, 0], [0, 2, 0, 3, 3, 2, 0, 0, 3, 3, 0], [0, 3, 1, 0, 3, 1, 0, 0, 0, 3, 3], [0, 3, 3, 2, 0, 2, 3, 0, 0, 3, 0], [0, 0, 3, 3, 1, 1, 3, 3, 0, 3, 3], [0, 0, 3, 3, 0, 0, 2, 3, 3, 0, 2], [0, 3, 0, 3, 3, 3, 3, 2, 0, 3, 2], [0, 0, 0, 3, 0, 3, 0, 3, 1, 3, 1], [0, 3, 0, 3, 0, 0, 3, 0, 3, 1, 1], [3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0]],[0.00896408387412595, 0.013909363000998987, 0.0119342195057911, 0.015880558184360072, 0.0119342195057911, 0.014895453637998046, 0.0119342195057911, 0.0119342195057911, 0.0119342195057911, 0.013909363000998987, 0.012922285286285251],[0.04411042164244039, 0.0677698805845951, 0.05837719308562428, 0.07706887602576384, 0.05837719308562428, 0.07243103118167216, 0.05837719308562428, 0.05837719308562428, 0.05837719308562428, 0.0677698805845951, 0.06308530712019611])        
code_12_1_5=CodeWithError([[1, 3, 0, 3, 0, 1, 0, 3, 3, 0, 0, 0], [0, 2, 0, 3, 3, 2, 0, 0, 3, 3, 0, 0], [0, 3, 1, 0, 3, 1, 0, 0, 0, 3, 3, 0], [0, 3, 3, 2, 0, 2, 3, 0, 0, 3, 0, 0], [0, 0, 3, 3, 1, 1, 3, 3, 0, 3, 3, 0], [0, 0, 3, 3, 0, 0, 2, 3, 
3, 0, 2, 0], [0, 3, 0, 3, 3, 3, 3, 2, 0, 3, 2, 0], [0, 0, 0, 3, 0, 3, 0, 3, 1, 3, 1, 0], [0, 3, 0, 3, 0, 0, 3, 0, 3, 1, 1, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], [3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0]],[0.00896408387412595, 0.013909363000998987, 0.0119342195057911, 0.015880558184360072, 0.0119342195057911, 0.014895453637998046, 0.0119342195057911, 0.0119342195057911, 0.0119342195057911, 0.013909363000998987, 0.012922285286285251, 0.00797205593005601],[0.04411042164244039, 0.0677698805845951, 0.05837719308562428, 0.07706887602576384, 0.05837719308562428, 0.07243103118167216, 0.05837719308562428, 0.05837719308562428, 0.05837719308562428, 0.0677698805845951, 0.06308530712019611, 0.039306956424563166])
code_13_1_5=CodeWithError([[1, 3, 0, 3, 0, 1, 0, 3, 3, 0, 0, 0, 0], [0, 2, 0, 3, 3, 2, 0, 0, 3, 3, 0, 0, 0], [0, 3, 1, 0, 3, 1, 0, 0, 0, 3, 3, 0, 0], [0, 3, 3, 2, 0, 2, 3, 0, 0, 3, 0, 0, 0], [0, 0, 3, 3, 1, 1, 3, 3, 0, 3, 3, 0, 0], [0, 0, 3, 
3, 0, 0, 2, 3, 3, 0, 2, 0, 0], [0, 3, 0, 3, 3, 3, 3, 2, 0, 3, 2, 0, 0], [0, 0, 0, 3, 0, 3, 0, 3, 1, 3, 1, 0, 0], [0, 3, 0, 3, 0, 0, 3, 0, 3, 1, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1], [3, 3, 3, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0]],[0.00896408387412595, 0.013909363000998987, 0.0119342195057911, 0.015880558184360072, 
0.0119342195057911, 0.014895453637998046, 0.0119342195057911, 0.0119342195057911, 0.0119342195057911, 0.013909363000998987, 0.012922285286285251, 0.00797205593005601, 0.00797205593005601],[0.04411042164244039, 0.0677698805845951, 0.05837719308562428, 0.07706887602576384, 0.05837719308562428, 0.07243103118167216, 0.05837719308562428, 0.05837719308562428, 0.05837719308562428, 0.0677698805845951, 0.06308530712019611, 0.039306956424563166, 0.039306956424563166])
code_513=CodeWithError([[2, 0, 3, 1, 2], [3, 1, 0, 3, 2], [3, 0, 1, 2, 3], [0, 3, 3, 3, 3]],[0.009955119790251765, 0.00896408387412595, 0.009955119790251765, 0.010945164670461582, 0.010945164670461582],[0.048889869534228136, 0.04411042164244039, 0.048889869534228136, 0.05364542018655705, 0.05364542018655705])
code_613=CodeWithError([[2, 0, 3, 1, 2, 0], [3, 1, 0, 3, 2, 0], [3, 0, 1, 2, 3, 0], [0, 0, 0, 0, 0, 1], [0, 3, 3, 3, 3, 0]],[0.009955119790251765, 0.00896408387412595, 0.009955119790251765, 0.010945164670461582, 0.010945164670461582, 0.00797205593005601],[0.048889869534228136, 0.04411042164244039, 0.048889869534228136, 0.05364542018655705, 0.05364542018655705, 
0.039306956424563166])
code_813=CodeWithError([[2, 0, 3, 1, 2, 0, 0, 0], [3, 1, 0, 3, 2, 0, 0, 0], [3, 0, 1, 2, 3, 0, 0, 0], [0, 0, 0, 0, 0, 1, 
0, 0], [0, 0, 0, 0, 0, 0, 1, 0], [0, 0, 0, 0, 0, 0, 0, 1], [0, 3, 3, 3, 3, 0, 0, 0]],[0.009955119790251765, 0.00896408387412595, 0.009955119790251765, 0.010945164670461582, 0.010945164670461582, 0.00797205593005601, 0.00797205593005601, 0.00797205593005601],[0.048889869534228136, 0.04411042164244039, 0.048889869534228136, 0.05364542018655705, 0.05364542018655705, 0.039306956424563166, 0.039306956424563166, 0.039306956424563166])
code_913=CodeWithError([[2, 0, 3, 1, 2, 0, 0, 0, 0], [3, 1, 0, 3, 2, 0, 0, 0, 0], [3, 0, 1, 2, 3, 0, 0, 0, 0], [0, 0, 0, 
0, 0, 1, 0, 0, 0], [0, 0, 0, 0, 0, 0, 1, 0, 0], [0, 0, 0, 0, 0, 0, 0, 1, 0], [0, 0, 0, 0, 0, 0, 0, 0, 1], [0, 3, 3, 3, 3, 0, 0, 0, 0]],[0.009955119790251765, 0.00896408387412595, 0.009955119790251765, 0.010945164670461582, 0.010945164670461582, 0.00797205593005601, 0.00797205593005601, 0.00797205593005601, 0.00797205593005601],[0.048889869534228136, 0.04411042164244039, 0.048889869534228136, 0.05364542018655705, 0.05364542018655705, 0.039306956424563166, 0.039306956424563166, 0.039306956424563166, 0.039306956424563166])
code_steane_713=CodeWithError([[1, 0, 0, 1, 0, 1, 1], [0, 1, 0, 1, 1, 1, 0], [0, 0, 1, 0, 1, 1, 1], [3, 0, 0, 3, 0, 3, 3], [0, 3, 0, 3, 3, 3, 0], [0, 0, 3, 0, 3, 3, 3]],[0.00896408387412595, 0.00896408387412595, 0.00896408387412595, 0.010945164670461582, 0.010945164670461582, 0.012922285286285251, 0.010945164670461582],[0.04411042164244039, 0.04411042164244039, 0.04411042164244039, 0.05364542018655705, 0.05364542018655705, 0.06308530712019611, 0.05364542018655705])

function CodeEval(code)
    stabs = code.stabs
    n = length(stabs[1])
    px = code.px
    pz =code.pz
    py = [px[i]*pz[i] for i in 1:n]  
    pl = activeCodeEval(stabs, 1, px, py, pz,MaxLikeDecode)
    return pl
end

candidate = [code_513,code_613,code_steane_713, code_813, code_913, code_10_1_4,code_11_1_5,code_12_1_5,code_13_1_5]
# candidate = [code_513,code_613,code_steane_713, code_813, code_913,]

code_5=CodeWithError([[0, 2, 3, 3, 1], [3, 0, 1, 3, 2], [3, 3, 0, 1, 1], [1, 3, 3, 0, 2]],[0.009955119790251765, 0.009955119790251765, 0.009955119790251765, 0.009955119790251765, 0.010945164670461582],[0.048889869534228136, 0.048889869534228136, 0.048889869534228136, 0.048889869534228136, 0.05364542018655705])
code_6=CodeWithError([[3, 1, 3, 0, 3, 2], [0, 3, 1, 3, 3, 2], [3, 3, 0, 2, 0, 1], [0, 0, 0, 0, 2, 1], [2, 0, 3, 3, 0, 1]],[0.009955119790251765, 0.009955119790251765, 0.009955119790251765, 0.009955119790251765, 0.009955119790251765, 0.0119342195057911],[0.048889869534228136, 0.048889869534228136, 0.048889869534228136, 0.048889869534228136, 0.048889869534228136, 0.05837719308562428])
code_7=CodeWithError([[3, 2, 0, 0, 3, 0, 2], [3, 0, 2, 0, 3, 0, 2], [3, 0, 0, 2, 3, 0, 2], [0, 3, 3, 3, 1, 3, 2], [3, 3, 
3, 3, 0, 2, 3], [1, 0, 0, 0, 3, 3, 3]],[0.0119342195057911, 0.009955119790251765, 0.009955119790251765, 0.009955119790251765, 0.0119342195057911, 0.009955119790251765, 0.012922285286285251],[0.05837719308562428, 0.048889869534228136, 0.048889869534228136, 0.048889869534228136, 0.05837719308562428, 0.048889869534228136, 0.06308530712019611])
code_8=CodeWithError([[0, 2, 3, 3, 3, 3, 1, 0], [3, 3, 1, 0, 0, 0, 1, 0], [3, 0, 3, 1, 3, 0, 2, 3], [3, 0, 3, 3, 1, 3, 2, 0], [3, 0, 3, 0, 3, 1, 2, 3], [0, 0, 0, 3, 0, 3, 0, 1], [1, 3, 0, 3, 3, 3, 2, 0]],[0.0119342195057911, 0.009955119790251765, 0.0119342195057911, 0.0119342195057911, 0.0119342195057911, 0.0119342195057911, 0.012922285286285251, 0.009955119790251765],[0.05837719308562428, 0.048889869534228136, 0.05837719308562428, 0.05837719308562428, 0.05837719308562428, 0.05837719308562428, 0.06308530712019611, 0.048889869534228136])
code_9=CodeWithError([[0, 2, 0, 2, 0, 0, 0, 0, 0], [0, 3, 2, 1, 0, 3, 3, 0, 2], [0, 0, 0, 0, 2, 3, 0, 3, 2], [0, 0, 0, 0, 0, 1, 3, 3, 3], [0, 0, 0, 0, 3, 3, 1, 0, 3], [0, 0, 0, 0, 3, 0, 3, 2, 2], [1, 0, 3, 2, 0, 3, 3, 0, 2], [3, 3, 3, 3, 0, 0, 0, 0, 0]],[0.00896408387412595, 0.009955119790251765, 0.009955119790251765, 0.010945164670461582, 0.009955119790251765, 0.0119342195057911, 0.0119342195057911, 0.009955119790251765, 0.012922285286285251],[0.04411042164244039, 0.048889869534228136, 0.048889869534228136, 0.05364542018655705, 0.048889869534228136, 0.05837719308562428, 0.05837719308562428, 0.048889869534228136, 0.06308530712019611])
code_10=CodeWithError([[3, 2, 0, 0, 3, 3, 0, 0, 1, 2], [3, 3, 1, 3, 3, 1, 0, 0, 0, 0], [3, 0, 0, 2, 0, 2, 0, 3, 2, 2], [0, 3, 0, 0, 2, 2, 0, 3, 2, 2], [0, 0, 0, 0, 0, 0, 1, 3, 3, 1], [0, 0, 0, 0, 0, 0, 0, 1, 1, 0], [2, 3, 0, 3, 0, 3, 0, 0, 1, 2], [0, 0, 3, 3, 3, 3, 0, 0, 0, 0], [0, 0, 0, 0, 0, 0, 3, 3, 3, 3]],[0.010945164670461582, 0.010945164670461582, 0.00896408387412595, 0.010945164670461582, 0.010945164670461582, 0.012922285286285251, 0.00896408387412595, 0.0119342195057911, 
0.013909363000998987, 0.012922285286285251],[0.05364542018655705, 0.05364542018655705, 0.04411042164244039, 0.05364542018655705, 0.05364542018655705, 0.06308530712019611, 0.04411042164244039, 0.05837719308562428, 0.0677698805845951, 0.06308530712019611])
code_11=CodeWithError([[0, 1, 0, 1, 3, 1, 3, 3, 3, 3, 3], [0, 0, 2, 2, 0, 1, 3, 0, 0, 3, 1], [0, 0, 3, 3, 1, 2, 0, 3, 3, 
0, 2], [0, 0, 0, 0, 0, 0, 2, 3, 0, 3, 2], [0, 0, 0, 0, 0, 0, 0, 1, 3, 3, 1], [0, 0, 0, 0, 0, 0, 3, 3, 1, 0, 1], [0, 0, 0, 0, 0, 0, 3, 0, 3, 2, 2], [1, 0, 3, 2, 3, 0, 0, 3, 3, 0, 2], [3, 0, 0, 3, 3, 3, 0, 0, 0, 0, 0], [0, 3, 3, 0, 3, 3, 0, 0, 
0, 0, 0]],[0.00896408387412595, 0.00896408387412595, 0.010945164670461582, 0.0119342195057911, 0.0119342195057911, 0.0119342195057911, 0.0119342195057911, 0.012922285286285251, 0.012922285286285251, 0.0119342195057911, 0.014895453637998046],[0.04411042164244039, 0.04411042164244039, 0.05364542018655705, 0.05837719308562428, 0.05837719308562428, 0.05837719308562428, 0.05837719308562428, 0.06308530712019611, 0.06308530712019611, 0.05837719308562428, 0.07243103118167216])
code_12=CodeWithError([[0, 1, 0, 3, 1, 1, 1, 3, 3, 3, 3, 3], [0, 3, 1, 0, 3, 1, 2, 0, 3, 3, 0, 2], [0, 3, 0, 2, 1, 0, 3, 
0, 3, 3, 0, 2], [0, 0, 0, 0, 0, 0, 0, 2, 3, 0, 3, 2], [0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 3, 1], [0, 0, 0, 0, 0, 0, 0, 3, 3, 1, 0, 1], [0, 0, 0, 0, 0, 0, 0, 3, 0, 3, 2, 2], [1, 3, 0, 3, 2, 1, 2, 3, 0, 0, 3, 1], [3, 3, 0, 3, 3, 0, 0, 0, 0, 0, 0, 0], [0, 0, 3, 3, 3, 0, 3, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 3, 3, 0, 0, 0, 0, 0]],[0.00896408387412595, 0.0119342195057911, 0.00896408387412595, 0.0119342195057911, 0.012922285286285251, 0.010945164670461582, 0.012922285286285251, 0.0119342195057911, 0.012922285286285251, 0.012922285286285251, 0.0119342195057911, 0.014895453637998046],[0.04411042164244039, 0.05837719308562428, 0.04411042164244039, 0.05837719308562428, 0.06308530712019611, 0.05364542018655705, 0.06308530712019611, 0.05837719308562428, 0.06308530712019611, 0.06308530712019611, 0.05837719308562428, 0.07243103118167216])
code_13=CodeWithError([[0, 1, 3, 0, 2, 3, 0, 0, 3, 3, 0, 2, 0], [0, 0, 1, 3, 2, 0, 0, 3, 3, 3, 0, 3, 2], [0, 0, 3, 2, 1, 
3, 0, 3, 0, 0, 0, 1, 2], [0, 0, 3, 0, 3, 2, 3, 0, 3, 0, 0, 2, 3], [0, 0, 0, 3, 3, 0, 1, 0, 3, 3, 3, 1, 0], [0, 0, 0, 3, 3, 0, 3, 2, 0, 3, 0, 3, 2], [0, 0, 0, 0, 0, 0, 3, 3, 1, 3, 3, 1, 0], [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 3, 1], [0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 2, 2, 3], [1, 0, 3, 3, 0, 3, 3, 3, 3, 0, 3, 2, 2], [3, 0, 3, 3, 0, 0, 0, 3, 0, 3, 0, 0, 3], [0, 3, 3, 
3, 3, 0, 0, 0, 0, 0, 0, 0, 0]],[0.00896408387412595, 0.00896408387412595, 0.013909363000998987, 0.013909363000998987, 0.013909363000998987, 0.010945164670461582, 0.0119342195057911, 0.012922285286285251, 0.012922285286285251, 0.014895453637998046, 0.0119342195057911, 0.016864677626175606, 0.014895453637998046],[0.04411042164244039, 0.04411042164244039, 0.0677698805845951, 0.0677698805845951, 0.0677698805845951, 0.05364542018655705, 0.05837719308562428, 0.06308530712019611, 0.06308530712019611, 0.07243103118167216, 0.05837719308562428, 0.08168353164563502, 0.07243103118167216])
candidate=[code_5,code_6,code_7,code_8,code_9,code_10,code_11,code_12,code_13]

code_12=CodeWithError([[0, 1, 0, 3, 2, 0, 0, 0, 0, 0, 0, 0], [0, 0, 2, 3, 2, 1, 2, 3, 3, 3, 3, 3], [0, 0, 0, 2, 3, 1, 1, 
0, 3, 3, 0, 2], [0, 0, 0, 0, 0, 0, 0, 2, 3, 0, 3, 2], [0, 0, 0, 0, 0, 0, 0, 0, 1, 3, 3, 1], [0, 0, 0, 0, 0, 0, 0, 3, 3, 1, 0, 1], [0, 0, 0, 0, 0, 0, 0, 3, 0, 3, 2, 2], [1, 0, 3, 0, 0, 1, 1, 0, 0, 0, 0, 0], [3, 0, 3, 3, 0, 0, 3, 0, 0, 0, 0, 0], [0, 3, 3, 0, 3, 0, 0, 0, 0, 0, 0, 0], [0, 0, 0, 0, 0, 3, 3, 0, 0, 0, 0, 0]],[0.00896408387412595, 0.00896408387412595, 
0.010945164670461582, 0.010945164670461582, 0.010945164670461582, 0.010945164670461582, 0.0119342195057911, 0.010945164670461582, 0.0119342195057911, 0.0119342195057911, 0.010945164670461582, 0.012922285286285251],[0.04411042164244039, 0.04411042164244039, 0.05364542018655705, 0.05364542018655705, 0.05364542018655705, 0.05364542018655705, 0.05837719308562428, 0.05364542018655705, 0.05837719308562428, 0.05837719308562428, 0.05364542018655705, 0.06308530712019611])
candidate=[code_12]

for code in candidate 
    pl = CodeEval(code)
    println(length(code.stabs[1]))
    println(pl)    
end
